groups:
- name: appliance-alerts
  rules:
  - alert: HostDiskSpaceLow
    expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"} ) < 0.20
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Disk space low"
      description: "Root filesystem has less than 20% free space for 10m."

  - alert: ContainerRestarting
    expr: increase(container_restart_count[15m]) > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Container restart detected"
      description: "A container has restarted in the last 15 minutes."

  - alert: TunnelNotHealthy
    expr: probe_success{job="blackbox-http"} == 0
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Seafile endpoint not reachable via Nginx"
      description: "Blackbox probe failed for Nginx/Seafile endpoint for 2 minutes."

  - alert: HighNodeMemoryUsage
    expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.90
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage"
      description: "Node memory usage above 90% for 10 minutes."

  - alert: HighCpuLoad
    expr: (avg by(instance) (rate(node_cpu_seconds_total{mode!="idle"}[5m]))) > 0.90
    for: 15m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage"
      description: "Average CPU usage above 90% for 15 minutes."
